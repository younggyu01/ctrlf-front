map $http_authorization $auth_present {
    default 1;
    ""      0;
}

log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" "$http_user_agent" '
                '"$http_x_forwarded_for" auth=$auth_present';

server {
    listen       80;
    server_name  front-service;

    access_log /dev/stdout main;
    error_log  /dev/stderr warn;

    # -----------------------------------------------------------------------------
    # Public Swagger (training / demo use)
    # - Expose backend Swagger UI via this public front-service LoadBalancer
    # - Avoid changing existing /api/ proxy behavior (it keeps the /api prefix)
    # -----------------------------------------------------------------------------

    # Why 405 happened:
    # - Swagger UI (webjar) defaults to calling "/admin/..." and "/v3/api-docs/..." on the LB root.
    # - This LB also serves the SPA, so those POSTs hit Nginx static hosting → 405 Method Not Allowed.
    #
    # Fix:
    # 1) Proxy everything under /infra/* and /edu/* to each backend (strip the prefix).
    # 2) Override swagger-initializer.js to prefix requests so "Try it out" works.

    # Swagger UI: force API calls to go through /infra/*
    location = /infra/swagger-ui/swagger-initializer.js {
        default_type application/javascript;
        return 200 'window.onload = function () {
  var prefix = "/infra";
  var origin = window.location.origin;
  window.ui = SwaggerUIBundle({
    url: prefix + "/v3/api-docs",
    dom_id: "#swagger-ui",
    deepLinking: true,
    presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
    plugins: [SwaggerUIBundle.plugins.DownloadUrl],
    layout: "StandaloneLayout",
    oauth2RedirectUrl: origin + prefix + "/swagger-ui/oauth2-redirect.html",
    requestInterceptor: function (req) {
      try {
        var u = new URL(req.url, origin);
        if (u.origin === origin && u.pathname.indexOf(prefix + "/") !== 0) {
          u.pathname = prefix + u.pathname;
          req.url = u.toString();
        }
      } catch (e) {}
      return req;
    },
    validatorUrl: ""
  });
};
';
    }

    # Swagger UI: force API calls to go through /edu/*
    location = /edu/swagger-ui/swagger-initializer.js {
        default_type application/javascript;
        return 200 'window.onload = function () {
  var prefix = "/edu";
  var origin = window.location.origin;
  window.ui = SwaggerUIBundle({
    url: prefix + "/v3/api-docs",
    dom_id: "#swagger-ui",
    deepLinking: true,
    presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
    plugins: [SwaggerUIBundle.plugins.DownloadUrl],
    layout: "StandaloneLayout",
    oauth2RedirectUrl: origin + prefix + "/swagger-ui/oauth2-redirect.html",
    requestInterceptor: function (req) {
      try {
        var u = new URL(req.url, origin);
        if (u.origin === origin && u.pathname.indexOf(prefix + "/") !== 0) {
          u.pathname = prefix + u.pathname;
          req.url = u.toString();
        }
      } catch (e) {}
      return req;
    },
    validatorUrl: ""
  });
};
';
    }

    # Generic prefix proxy (lets prefixed "Try it out" requests reach each backend)
    location ^~ /infra/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /infra;
        rewrite ^/infra(/.*)$ $1 break;
        proxy_pass http://infra-service:9003;
    }

    location ^~ /edu/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /edu;
        rewrite ^/edu(/.*)$ $1 break;
        proxy_pass http://education-service:9002;
    }

    # Keycloak (same-origin proxy)
    # - Frontend uses `${window.location.origin}/auth` as default Keycloak URL in EKS.
    # - Keycloak itself is configured with KC_HTTP_RELATIVE_PATH=/auth.
    location ^~ /auth/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        # CloudFront connects to origin via HTTP, but viewers are HTTPS (redirect-to-https).
        # Force https so Keycloak generates https URLs and redirects.
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Forwarded-Host $host;
        proxy_pass http://keycloak-service:8090;
    }

    # Optional convenience: allow root /admin/* to reach infra-service directly
    # (copied curl from Swagger without prefix)
    location ^~ /admin/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_pass http://infra-service:9003;
    }

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
        # React/Vue 라우팅 대응: 경로를 찾지 못하면 index.html로 리다이렉트
        try_files $uri $uri/ /index.html;
    }

    # Chat Service (most specific first)
    # - Frontend calls chat APIs via /api/chat/* (and some endpoints under /chat/*).
    location ^~ /api/chat/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Viewers are HTTPS via CloudFront; reflect external scheme to upstreams.
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-User-UUID $http_x_user_uuid;
        proxy_pass http://chat-service:9005;
    }

    location ^~ /chat/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-User-UUID $http_x_user_uuid;
        proxy_pass http://chat-service:9005;
    }

    # API 요청을 백엔드 서비스(Infra, Chat 등)로 프록시
    location /api/ {
        proxy_pass http://infra-service:9003; # 내부 k8s 서비스 이름 사용
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}